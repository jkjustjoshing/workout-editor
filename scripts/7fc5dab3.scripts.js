Math.toRadians=function(a){return a*Math.PI/180},angular.module("workoutEditorApp",["ngCookies","ngResource","ngSanitize","ngRoute","ui.router"]).config(["$stateProvider","$urlRouterProvider",function(a,b){b.otherwise("/"),a.state("/",{url:"/",templateUrl:"views/main.html",controller:"MainCtrl"}).state("edit",{url:"/edit",templateUrl:"views/edit.html",controller:"EditCtrl"})}]),angular.module("workoutEditorApp").controller("MainCtrl",["$scope","GPX","TCX","Trackpoints","$state",function(a,b,c,d,e){a.$watch("file",function(a){if(a){var f=new FileReader;f.readAsText(a),f.onload=function(){var g=a.name.split(".");switch(g[g.length-1]){case"tcx":var h=c.parse(f.result);d.setList(h.trackpoints);break;case"gpx":var h=b.parse(f.result);d.setList(h.trackpoints);break;default:console.log("File not supported")}e.go("edit")}}}),window.Trackpoints=d}]),angular.module("workoutEditorApp").controller("EditCtrl",["$scope","Trackpoints","$state",function(a,b,c){return 0===b.getList().length?void c.transitionTo("/"):(a.totalDistance=b.totalDistance(),a.distanceIntervals=1,void a.$watch("distanceIntervals",function(c){c&&(a.laps=b.getLaps(c))}))}]),angular.module("workoutEditorApp").factory("Trackpoints",["moment",function(a){var b=function(b){this.data={latitude:b.latitude,longitude:b.longitude,elevation:b.elevation,time:a(b.time)}};b.prototype.getLatitude=function(){return this.data.latitude},b.prototype.getLongitude=function(){return this.data.longitude},b.prototype.getTime=function(){return this.data.time},b.prototype.getGoogleLatLng=function(){return new google.maps.LatLng(this.data.latitude,this.data.longitude)},b.prototype.distance=function(a){var b=this.data.latitude,c=this.data.longitude,d=a.data.latitude,e=a.data.longitude;if(!(b&&c&&d&&e))return 0;var f=3961,g=Math.toRadians(d-b),h=Math.toRadians(e-c),i=Math.toRadians(b),j=Math.toRadians(d),k=Math.sin(g/2)*Math.sin(g/2)+Math.sin(h/2)*Math.sin(h/2)*Math.cos(i)*Math.cos(j),l=2*Math.atan2(Math.sqrt(k),Math.sqrt(1-k));return f*l};var c=function(){var a={latitude:d[0].getLatitude(),longitude:d[0].getLongitude()},b={latitude:d[0].getLatitude(),longitude:d[0].getLongitude()};return d.forEach(function(c){c.getLatitude()>a.latitude?a.latitude=c.getLatitude():c.getLatitude()<b.latitude&&(b.latitude=c.getLatitude()),c.getLongitude()<a.longitude?a.longitude=c.getLongitude():c.getLongitude()>b.longitude&&(b.longitude=c.getLongitude())}),{upperLeft:a,lowerRight:b}},d=[];return{"new":function(a){return new b(a)},add:function(a){d.push(a instanceof b?a:new b(a))},addList:function(a){a.forEach(function(a){this.add(a)}.bind(this))},getList:function(){return d},setList:function(a){d=[],this.addList(a)},totalDistance:function(){for(var a=0,b=1;b<d.length;++b)a+=d[b].distance(d[b-1]);return a},getLaps:function(a){a||(a=1);for(var b=1,c=0,e=[],f=d[0],g=1;g<d.length;++g)if(c+=d[g].distance(d[g-1]),c>b*a)e.push({seconds:d[g].getTime().diff(f.getTime())/1e3,distance:a,totalDistance:c,startPoint:f,endPoint:d[g]}),f=d[g],b++;else if(g+1===d.length){var a=c-e[e.length-1].totalDistance;e.push({seconds:d[g].getTime().diff(f.getTime())/1e3,distance:a,totalDistance:c,startPoint:f,endPoint:d[g]})}return e},getCenterPoint:function(){var a=c(),d=new b({latitude:(a.upperLeft.latitude+a.lowerRight.latitude)/2,longitude:(a.upperLeft.longitude+a.lowerRight.longitude)/2});return d},getNorthEast:function(){var a=c();return new b({latitude:a.upperLeft.latitude,longitude:a.lowerRight.longitude})},getSouthWest:function(){var a=c();return new b({latitude:a.lowerRight.latitude,longitude:a.upperLeft.longitude})}}}]),angular.module("workoutEditorApp").factory("GPX",["moment",function(a){return{parse:function(b){var c={},d=angular.element,e=d(d.parseXML(b)).find("gpx"),f=e.children("trk").first();return c.type=f.children("name").text().split(" ")[0],c.trackpoints=[],f.children("trkseg").children("trkpt").each(function(){var b=d(this);c.trackpoints.push({latitude:parseFloat(b.attr("lat")),longitude:parseFloat(b.attr("lon")),time:a(b.children("time").text())})}),c}}}]),angular.module("workoutEditorApp").factory("TCX",["moment",function(a){return{parse:function(b){var c={},d=angular.element,e=d(d.parseXML(b)).find("TrainingCenterDatabase"),f=e.children("Activities").first().children("Activity").first();return c.type=f.attr("Sport"),c.trackpoints=[],f.children("Lap").each(function(){d(this).children("Track").children("Trackpoint").each(function(){c.trackpoints.push({latitude:parseFloat(d(this).children("Position").children("LatitudeDegrees").text()),longitude:parseFloat(d(this).children("Position").children("LongitudeDegrees").text()),time:a(d(this).children("Time").text()),altitudeMeters:parseFloat(d(this).children("AltitudeMeters").text())})})}),c}}}]),angular.module("workoutEditorApp").value("moment",window.moment),angular.module("workoutEditorApp").filter("time",function(){return function(a,b){var c=Math.floor(a/3600),d=Math.floor(a%3600/60),a=a%60;if(a=10>a?"0"+a:""+a,c>0&&10>d&&(d="0"+d),console.log({decimalPlaces:b,seconds:a}),0===b)a=a.split(".")[0];else if(void 0!==b){var e=a.split(".");e.length>1&&e[1].length>b&&(e[1]=e[1].substr(0,b)),a=e.join(".")}return c>0?c+":"+d+":"+a:d+":"+a}}),angular.module("workoutEditorApp").directive("jkGoogleMap",["Trackpoints",function(a){return{restrict:"A",scope:{passedOptions:"&"},link:function(b,c){var d={mapTypeId:google.maps.MapTypeId.ROADMAP};b.options=angular.extend({},d,b.passedOptions);var e=!0;b.$watch(function(){return a.getList()},function(d){if(d&&d.length&&e){e=!1;var f=[];d.forEach(function(a){f.push(a.getGoogleLatLng())});var g=new google.maps.Map(c[0],b.options),h=new google.maps.Polyline({path:f,geodesic:!0,strokeColor:"#FF0000",strokeOpacity:1,strokeWeight:2});h.setMap(g);var i=new google.maps.LatLngBounds;i.extend(a.getNorthEast().getGoogleLatLng()),i.extend(a.getSouthWest().getGoogleLatLng()),g.fitBounds(i)}})}}}]),angular.module("workoutEditorApp").directive("input",function(){return{restrict:"E",scope:{ngModel:"="},link:function(a,b,c){"file"===c.type&&(b.unbind("change"),b.bind("change",function(){a.$apply(function(){a.ngModel=event.target.files[0]}.bind(this))}))}}});